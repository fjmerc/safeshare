<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - SafeShare</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="manifest" href="/assets/manifest.json">
    <meta name="theme-color" content="#3b82f6">

    <!-- Load theme before CSS to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <link rel="stylesheet" href="/admin/assets/admin.css">
    <style>
        /* MFA Section Styles */
        .mfa-section {
            display: none;
        }
        .mfa-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .mfa-header h2 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: var(--text-primary);
        }
        .mfa-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .mfa-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            background: var(--primary-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mfa-icon svg {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }
        .totp-input {
            letter-spacing: 0.5em;
            text-align: center;
            font-size: 24px;
            font-family: monospace;
        }
        .mfa-methods {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .mfa-method-toggle {
            display: block;
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .mfa-method-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        .recovery-input {
            font-family: monospace;
            text-transform: uppercase;
        }
        .mfa-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 16px;
        }
        .mfa-back-btn:hover {
            color: var(--primary);
        }
        .mfa-timer {
            text-align: center;
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        .mfa-timer.expiring {
            color: var(--error);
        }
    </style>
</head>
<body class="login-page">
    <!-- Theme Toggle -->
    <button id="themeToggle" class="theme-toggle-fixed" title="Toggle theme">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="theme-icon-sun">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="theme-icon-moon" style="display: none;">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <div class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <img src="/assets/logo.svg" alt="SafeShare Logo">
            </div>
            <h1>SafeShare Admin</h1>
            <p class="subtitle">Secure file sharing administration</p>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required autocomplete="username" autofocus>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" name="password" required autocomplete="current-password">
                        <button type="button" class="password-toggle" data-password-toggle="password" aria-label="Toggle password visibility">
                            <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <svg class="eye-off-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                <line x1="1" y1="1" x2="23" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="button-container">
                    <button type="submit" class="btn-primary btn-login">Login</button>
                </div>
            </form>

            <!-- MFA Verification Section (hidden by default) -->
            <div id="mfaSection" class="mfa-section">
                <button type="button" class="mfa-back-btn" id="mfaBackBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to login
                </button>

                <!-- TOTP Verification Form -->
                <div id="totpForm">
                    <div class="mfa-header">
                        <div class="mfa-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <h2>Two-Factor Authentication</h2>
                        <p>Enter the 6-digit code from your authenticator app</p>
                    </div>

                    <form id="mfaTotpForm">
                        <div class="form-group">
                            <label for="totpCode">Verification Code</label>
                            <input type="text" id="totpCode" name="totpCode"
                                   class="totp-input"
                                   maxlength="6"
                                   pattern="[0-9]{6}"
                                   inputmode="numeric"
                                   autocomplete="one-time-code"
                                   placeholder="000000"
                                   required>
                        </div>
                        <div class="button-container">
                            <button type="submit" class="btn-primary btn-login" id="mfaVerifyBtn">Verify</button>
                        </div>
                    </form>

                    <div class="mfa-methods" id="mfaMethods">
                        <button type="button" class="mfa-method-toggle" id="useRecoveryBtn">
                            Use a recovery code instead
                        </button>
                    </div>
                </div>

                <!-- Recovery Code Form (hidden by default) -->
                <div id="recoveryForm" style="display: none;">
                    <div class="mfa-header">
                        <div class="mfa-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                            </svg>
                        </div>
                        <h2>Recovery Code</h2>
                        <p>Enter one of your recovery codes</p>
                    </div>

                    <form id="mfaRecoveryForm">
                        <div class="form-group">
                            <label for="recoveryCode">Recovery Code</label>
                            <input type="text" id="recoveryCode" name="recoveryCode"
                                   class="recovery-input"
                                   placeholder="XXXX-XXXX-XXXX-XXXX"
                                   autocomplete="off"
                                   required>
                        </div>
                        <div class="button-container">
                            <button type="submit" class="btn-primary btn-login" id="recoveryVerifyBtn">Verify</button>
                        </div>
                    </form>

                    <div class="mfa-methods">
                        <button type="button" class="mfa-method-toggle" id="useTotpBtn">
                            Use authenticator app instead
                        </button>
                    </div>
                </div>

                <div class="mfa-timer" id="mfaTimer">Session expires in <span id="mfaTimeLeft">5:00</span></div>
            </div>

            <div class="footer">
                <p>SafeShare &copy; 2025 | <a href="/">Return to Upload</a></p>
            </div>
        </div>
    </div>

    <script src="/admin/assets/admin.js"></script>
    <script>
        // ============================================
        // MFA State Variables
        // ============================================
        let mfaChallengeId = null;
        let mfaExpiresAt = null;
        let mfaTimerInterval = null;
        let mfaAvailableMethods = [];

        // DOM elements
        const loginForm = document.getElementById('loginForm');
        const mfaSection = document.getElementById('mfaSection');
        const totpForm = document.getElementById('totpForm');
        const recoveryForm = document.getElementById('recoveryForm');
        const mfaMethods = document.getElementById('mfaMethods');
        const mfaBackBtn = document.getElementById('mfaBackBtn');
        const useRecoveryBtn = document.getElementById('useRecoveryBtn');
        const useTotpBtn = document.getElementById('useTotpBtn');
        const mfaTimeLeft = document.getElementById('mfaTimeLeft');
        const mfaTimer = document.getElementById('mfaTimer');

        // ============================================
        // MFA Functions
        // ============================================
        function showMFASection(data) {
            // Store challenge info
            mfaChallengeId = data.challenge_id;
            mfaExpiresAt = Date.now() + (data.expires_in * 1000);
            mfaAvailableMethods = data.available_methods || ['totp'];

            // Hide login form
            loginForm.style.display = 'none';

            // Show MFA section
            mfaSection.style.display = 'block';

            // Show/hide recovery option based on available methods
            if (mfaAvailableMethods.includes('recovery')) {
                mfaMethods.style.display = 'block';
            } else {
                mfaMethods.style.display = 'none';
            }

            // Reset forms
            document.getElementById('totpCode').value = '';
            document.getElementById('recoveryCode').value = '';
            totpForm.style.display = 'block';
            recoveryForm.style.display = 'none';

            // Auto-focus TOTP input
            setTimeout(() => {
                document.getElementById('totpCode').focus();
            }, 100);

            // Start countdown timer
            startMFATimer();
        }

        function resetToLogin() {
            // Clear MFA state
            mfaChallengeId = null;
            mfaExpiresAt = null;
            mfaAvailableMethods = [];
            if (mfaTimerInterval) {
                clearInterval(mfaTimerInterval);
                mfaTimerInterval = null;
            }

            // Hide MFA section
            mfaSection.style.display = 'none';

            // Show login form
            loginForm.style.display = 'block';

            // Clear password field for security
            document.getElementById('password').value = '';

            // Re-enable login button
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Login';
        }

        function startMFATimer() {
            if (mfaTimerInterval) {
                clearInterval(mfaTimerInterval);
            }

            function updateTimer() {
                const remaining = Math.max(0, mfaExpiresAt - Date.now());
                const seconds = Math.floor(remaining / 1000);
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;

                mfaTimeLeft.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;

                // Add warning style when less than 60 seconds
                if (seconds < 60) {
                    mfaTimer.classList.add('expiring');
                } else {
                    mfaTimer.classList.remove('expiring');
                }

                // Handle expiry
                if (remaining <= 0) {
                    clearInterval(mfaTimerInterval);
                    showToast('MFA session expired. Please log in again.', 'error');
                    resetToLogin();
                }
            }

            updateTimer();
            mfaTimerInterval = setInterval(updateTimer, 1000);
        }

        async function verifyMFA(code, isRecovery = false) {
            const verifyBtn = isRecovery
                ? document.getElementById('recoveryVerifyBtn')
                : document.getElementById('mfaVerifyBtn');

            const originalText = verifyBtn.textContent;
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';

            try {
                const response = await fetch('/api/auth/mfa/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        challenge_id: mfaChallengeId,
                        code: code,
                        is_recovery: isRecovery
                    }),
                    credentials: 'include',
                });

                const data = await response.json();

                if (response.ok) {
                    // Clear timer
                    if (mfaTimerInterval) {
                        clearInterval(mfaTimerInterval);
                    }

                    // Store CSRF token if provided
                    if (data.csrf_token) {
                        sessionStorage.setItem('csrf_token', data.csrf_token);
                    }

                    showToast('Verification successful! Redirecting...', 'success');

                    // Redirect to admin dashboard
                    setTimeout(() => {
                        window.location.href = '/admin/dashboard';
                    }, 1000);
                } else {
                    showToast(data.error || 'Verification failed. Please try again.', 'error');
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = originalText;

                    // Clear the input on failure
                    if (isRecovery) {
                        document.getElementById('recoveryCode').value = '';
                        document.getElementById('recoveryCode').focus();
                    } else {
                        document.getElementById('totpCode').value = '';
                        document.getElementById('totpCode').focus();
                    }
                }
            } catch (error) {
                console.error('MFA verification error:', error);
                showToast('Network error. Please try again.', 'error');
                verifyBtn.disabled = false;
                verifyBtn.textContent = originalText;
            }
        }

        // ============================================
        // Event Handlers
        // ============================================

        // Handle login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            try {
                const response = await fetch('/admin/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Check if MFA is required
                    if (data.mfa_required) {
                        showMFASection(data);
                        return;
                    }

                    if (data.success) {
                        // Store CSRF token
                        if (data.csrf_token) {
                            sessionStorage.setItem('csrf_token', data.csrf_token);
                        }
                        // Show success toast
                        showToast('Login successful! Redirecting...', 'success');

                        // Redirect to dashboard after brief delay
                        setTimeout(() => {
                            window.location.href = '/admin/dashboard';
                        }, 1000);
                    }
                } else {
                    showToast(data.error || 'Login failed. Please try again.', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Login';
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Network error. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        });

        // TOTP form submission
        document.getElementById('mfaTotpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('totpCode').value.trim();

            // Validate 6 digits
            if (!/^\d{6}$/.test(code)) {
                showToast('Please enter a 6-digit code', 'error');
                return;
            }

            await verifyMFA(code, false);
        });

        // Recovery code form submission
        document.getElementById('mfaRecoveryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('recoveryCode').value.trim().toUpperCase();

            // Basic format validation
            if (code.length < 10) {
                showToast('Please enter a valid recovery code', 'error');
                return;
            }

            await verifyMFA(code, true);
        });

        // Back to login button
        mfaBackBtn.addEventListener('click', () => {
            resetToLogin();
        });

        // Switch to recovery code form
        useRecoveryBtn.addEventListener('click', () => {
            totpForm.style.display = 'none';
            recoveryForm.style.display = 'block';
            document.getElementById('recoveryCode').focus();
        });

        // Switch to TOTP form
        useTotpBtn.addEventListener('click', () => {
            recoveryForm.style.display = 'none';
            totpForm.style.display = 'block';
            document.getElementById('totpCode').focus();
        });

        // Auto-format TOTP input (digits only)
        document.getElementById('totpCode').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
        });

        // Auto-format recovery code input
        document.getElementById('recoveryCode').addEventListener('input', (e) => {
            // Remove non-alphanumeric except dashes
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            e.target.value = value;
        });
    </script>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Toast Notification System -->
    <script src="/assets/toast.js"></script>
</body>
</html>
