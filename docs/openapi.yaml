openapi: 3.0.3
info:
  title: SafeShare API
  description: |
    SafeShare is a secure file sharing service with support for large file uploads, 
    password protection, expiration controls, and enterprise features.
    
    ## Authentication
    
    SafeShare supports two authentication methods:
    
    ### Session Cookie Authentication
    Traditional web session using `user_session` cookie. Obtained via `/api/auth/login`.
    
    ### API Token Authentication (Bearer)
    For SDKs, CLIs, and automation. Include token in Authorization header:
    ```
    Authorization: Bearer safeshare_<token>
    ```
    
    API tokens support granular scopes: `upload`, `download`, `manage`, `admin`.
    
    ## Rate Limiting
    
    Rate limits are applied per IP address:
    - Uploads: Configurable (default: 10/hour)
    - Downloads: Configurable (default: 50/hour)
    - Login attempts: 5 per 15 minutes
    
    When rate limited, endpoints return `429 Too Many Requests`.
    
  version: 2.8.4
  contact:
    name: SafeShare Support
    url: https://github.com/fjmerc/safeshare
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://yourdomain.com
    description: Production server

tags:
  - name: Health
    description: Health check and monitoring endpoints
  - name: Configuration
    description: Public configuration endpoints
  - name: Authentication
    description: User and admin authentication
  - name: Files
    description: File upload and download operations
  - name: Chunked Upload
    description: Large file chunked upload operations
  - name: User Files
    description: User file management operations
  - name: API Tokens
    description: API token management for programmatic access
  - name: Admin
    description: Administrative operations (requires admin role)
  - name: Webhooks
    description: Webhook configuration and delivery management

paths:
  # ==================== Health Endpoints ====================
  /health:
    get:
      tags:
        - Health
      summary: Comprehensive health check
      description: |
        Returns detailed health status including storage metrics, database health,
        and system resource usage. Returns 503 if service is degraded or unhealthy.
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is degraded or unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: Fast health check for process aliveness (< 10ms). Use for Kubernetes liveness probes.
      operationId: getLiveness
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LivenessResponse'

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: Check if service is ready to accept traffic. Use for Kubernetes readiness probes.
      operationId: getReadiness
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'

  /metrics:
    get:
      tags:
        - Health
      summary: Prometheus metrics
      description: Expose metrics in Prometheus format for monitoring and alerting.
      operationId: getMetrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string

  # ==================== Configuration Endpoints ====================
  /api/config:
    get:
      tags:
        - Configuration
      summary: Get public configuration
      description: Retrieve public-facing configuration for frontend clients.
      operationId: getPublicConfig
      responses:
        '200':
          description: Public configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicConfig'

  # ==================== Authentication Endpoints ====================
  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Create an authenticated session for a user account.
      operationId: userLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
              description: user_session cookie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Account disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many login attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: End the current user session.
      operationId: userLogout
      security:
        - sessionAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/user:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Retrieve information about the currently authenticated user.
      operationId: getCurrentUser
      security:
        - sessionAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/change-password:
    post:
      tags:
        - Authentication
      summary: Change password
      description: Update the current user's password.
      operationId: changePassword
      security:
        - sessionAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '200':
          description: Password changed successfully
        '400':
          description: Password validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Current password incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== File Upload Endpoints ====================
  /api/upload:
    post:
      tags:
        - Files
      summary: Upload file
      description: |
        Upload a file and receive a unique claim code. For files under the chunked 
        upload threshold (default: 100MB).
        
        Authentication is optional unless `REQUIRE_AUTH_FOR_UPLOAD` is enabled.
      operationId: uploadFile
      security:
        - {}
        - sessionAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: The file to upload
                expires_in_hours:
                  type: number
                  description: Hours until expiration (default 24, 0 = never expire)
                  example: 48
                max_downloads:
                  type: integer
                  description: Maximum downloads (0 = unlimited)
                  example: 5
                password:
                  type: string
                  description: Password protection for the file
                  format: password
      responses:
        '201':
          description: Upload successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: Invalid parameters or missing file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Authentication required (if REQUIRE_AUTH_FOR_UPLOAD=true)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: File exceeds MAX_FILE_SIZE
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '507':
          description: Disk full or quota exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== Chunked Upload Endpoints ====================
  /api/upload/init:
    post:
      tags:
        - Chunked Upload
      summary: Initialize chunked upload
      description: |
        Initialize a chunked upload session for large files (>= CHUNKED_UPLOAD_THRESHOLD).
        Returns an upload_id to use for subsequent chunk uploads.
      operationId: initChunkedUpload
      security:
        - {}
        - sessionAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChunkedUploadInitRequest'
      responses:
        '201':
          description: Upload session initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChunkedUploadInitResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: Total size exceeds limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Chunked uploads disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/upload/chunk/{upload_id}/{chunk_number}:
    post:
      tags:
        - Chunked Upload
      summary: Upload chunk
      description: |
        Upload a single chunk of a file. Chunks can be uploaded in any order
        and are idempotent (same chunk can be re-uploaded safely).
      operationId: uploadChunk
      security:
        - {}
        - sessionAuth: []
        - bearerAuth: []
      parameters:
        - name: upload_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Upload session ID from init
        - name: chunk_number
          in: path
          required: true
          schema:
            type: integer
            minimum: 0
          description: Zero-based chunk index
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - chunk
              properties:
                chunk:
                  type: string
                  format: binary
                  description: Chunk data
      responses:
        '200':
          description: Chunk uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChunkUploadResponse'
        '400':
          description: Invalid upload_id format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Upload session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Upload already completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '410':
          description: Upload session expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: Chunk too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/upload/complete/{upload_id}:
    post:
      tags:
        - Chunked Upload
      summary: Complete chunked upload
      description: |
        Finalize a chunked upload and assemble the file. May return 202 Accepted
        for large files that require async processing.
      operationId: completeChunkedUpload
      security:
        - {}
        - sessionAuth: []
        - bearerAuth: []
      parameters:
        - name: upload_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Upload session ID from init
      responses:
        '200':
          description: Upload complete (synchronous or already completed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '202':
          description: Assembly in progress (async)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncUploadResponse'
        '400':
          description: Missing chunks or invalid upload_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Upload session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/upload/status/{upload_id}:
    get:
      tags:
        - Chunked Upload
      summary: Check upload status
      description: Check the status of a chunked upload session.
      operationId: getUploadStatus
      security:
        - {}
        - sessionAuth: []
        - bearerAuth: []
      parameters:
        - name: upload_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Upload session ID from init
      responses:
        '200':
          description: Upload status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadStatusResponse'
        '404':
          description: Upload session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== File Download Endpoints ====================
  /api/claim/{code}:
    get:
      tags:
        - Files
      summary: Download file
      description: |
        Download a file using its claim code. Supports HTTP Range requests for
        resumable downloads. If file is password-protected, provide password
        via query parameter.
      operationId: downloadFile
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          description: File claim code
        - name: password
          in: query
          required: false
          schema:
            type: string
          description: Password for protected files
      responses:
        '200':
          description: File content
          headers:
            Content-Type:
              schema:
                type: string
              description: File MIME type
            Content-Disposition:
              schema:
                type: string
              description: 'attachment; filename="original_name.pdf"'
            Content-Length:
              schema:
                type: integer
              description: File size in bytes
            Accept-Ranges:
              schema:
                type: string
              description: bytes
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '206':
          description: Partial content (Range request)
          headers:
            Content-Range:
              schema:
                type: string
              description: 'bytes 0-999/10000'
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          description: Password required or incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invalid claim code or file expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '410':
          description: Download limit reached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '416':
          description: Invalid byte range
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/claim/{code}/info:
    get:
      tags:
        - Files
      summary: Get file info
      description: Retrieve file metadata without downloading.
      operationId: getFileInfo
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          description: File claim code
        - name: password
          in: query
          required: false
          schema:
            type: string
          description: Password for protected files
      responses:
        '200':
          description: File metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileInfoResponse'
        '401':
          description: Password required or incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invalid claim code or file expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== User File Management Endpoints ====================
  /api/user/files:
    get:
      tags:
        - User Files
      summary: List user's files
      description: Retrieve paginated list of files uploaded by the current user.
      operationId: listUserFiles
      security:
        - sessionAuth: []
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Number of results per page
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: List of user's files
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserFilesResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/user/files/delete:
    delete:
      tags:
        - User Files
      summary: Delete user's file
      description: Delete a file owned by the current user.
      operationId: deleteUserFile
      security:
        - sessionAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_id
              properties:
                file_id:
                  type: integer
                  description: File ID to delete
      responses:
        '200':
          description: File deleted successfully
        '403':
          description: File not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/user/files/rename:
    post:
      tags:
        - User Files
      summary: Rename user's file
      description: Change the original filename of a user's uploaded file.
      operationId: renameUserFile
      security:
        - sessionAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_id
                - new_filename
              properties:
                file_id:
                  type: integer
                  description: File ID to rename
                new_filename:
                  type: string
                  description: New filename
                  example: updated-document.pdf
      responses:
        '200':
          description: File renamed successfully
        '400':
          description: Invalid filename
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: File not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/user/files/update-expiration:
    post:
      tags:
        - User Files
      summary: Update file expiration
      description: Modify the expiration time of a user's uploaded file.
      operationId: updateFileExpiration
      security:
        - sessionAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_id
                - expires_in_hours
              properties:
                file_id:
                  type: integer
                  description: File ID to update
                expires_in_hours:
                  type: number
                  description: New expiration in hours from now
                  example: 72
      responses:
        '200':
          description: Expiration updated successfully
        '400':
          description: Invalid expiration value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: File not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/user/files/regenerate-claim-code:
    post:
      tags:
        - User Files
      summary: Regenerate claim code
      description: Generate a new claim code for a user's uploaded file. Old code becomes invalid.
      operationId: regenerateClaimCode
      security:
        - sessionAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_id
              properties:
                file_id:
                  type: integer
                  description: File ID to regenerate code for
      responses:
        '200':
          description: New claim code generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  claim_code:
                    type: string
                    description: New claim code
                  download_url:
                    type: string
                    description: New download URL
        '403':
          description: File not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== API Token Endpoints ====================
  /api/tokens:
    post:
      tags:
        - API Tokens
      summary: Create API token
      description: |
        Create a new API token for the authenticated user.
        
        **Important**: Token creation requires session authentication. API tokens
        cannot create other tokens (security measure).
        
        The full token value is only returned in this response - store it securely.
      operationId: createToken
      security:
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTokenRequest'
      responses:
        '201':
          description: Token created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenCreatedResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: |
            Forbidden. Possible reasons:
            - SESSION_REQUIRED: API tokens cannot create other tokens
            - SCOPE_EXCEEDS_ROLE: Requested scopes exceed user's role
            - MAX_TOKENS_REACHED: User has 50 tokens already
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags:
        - API Tokens
      summary: List API tokens
      description: Retrieve all API tokens for the authenticated user.
      operationId: listTokens
      security:
        - sessionAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: List of tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tokens/{id}:
    delete:
      tags:
        - API Tokens
      summary: Revoke API token
      description: |
        Revoke (delete) an API token.
        
        **Important**: Token revocation requires session authentication. API tokens
        cannot revoke other tokens (security measure).
      operationId: revokeToken
      security:
        - sessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Token ID to revoke
      responses:
        '200':
          description: Token revoked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Token revoked successfully
        '400':
          description: Invalid token ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: SESSION_REQUIRED - API tokens cannot revoke other tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Token not found or not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== Admin Authentication ====================
  /admin/api/login:
    post:
      tags:
        - Admin
      summary: Admin login
      description: Create an authenticated admin session.
      operationId: adminLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
              description: admin_session and csrf_token cookies
          content:
            application/json:
              schema:
                type: object
                properties:
                  username:
                    type: string
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many login attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/logout:
    post:
      tags:
        - Admin
      summary: Admin logout
      description: End the current admin session.
      operationId: adminLogout
      security:
        - adminAuth: []
      responses:
        '200':
          description: Logout successful

  # ==================== Admin Dashboard ====================
  /admin/api/dashboard:
    get:
      tags:
        - Admin
      summary: Get dashboard data
      description: Retrieve admin dashboard statistics and file listings.
      operationId: getDashboardData
      security:
        - adminAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: Files per page
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
        - name: search
          in: query
          schema:
            type: string
          description: Search query (claim code, filename, or uploader IP)
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/config:
    get:
      tags:
        - Admin
      summary: Get server configuration
      description: Retrieve current server configuration.
      operationId: getAdminConfig
      security:
        - adminAuth: []
      responses:
        '200':
          description: Server configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminConfigResponse'

  # ==================== Admin File Operations ====================
  /admin/api/files/delete:
    post:
      tags:
        - Admin
      summary: Delete file (admin)
      description: Delete any file from the system.
      operationId: adminDeleteFile
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - claim_code
              properties:
                claim_code:
                  type: string
                  description: Claim code of file to delete
      responses:
        '200':
          description: File deleted successfully
        '403':
          description: CSRF validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/files/delete/bulk:
    post:
      tags:
        - Admin
      summary: Bulk delete files
      description: Delete multiple files at once.
      operationId: adminBulkDeleteFiles
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - claim_codes
              properties:
                claim_codes:
                  type: array
                  items:
                    type: string
                  description: Claim codes to delete
      responses:
        '200':
          description: Files deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted_count:
                    type: integer

  # ==================== Admin IP Management ====================
  /admin/api/ip/block:
    post:
      tags:
        - Admin
      summary: Block IP address
      description: Add an IP address to the blocklist.
      operationId: blockIP
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ip_address
              properties:
                ip_address:
                  type: string
                  format: ipv4
                  description: IP address to block
                reason:
                  type: string
                  description: Reason for blocking
      responses:
        '200':
          description: IP blocked successfully

  /admin/api/ip/unblock:
    post:
      tags:
        - Admin
      summary: Unblock IP address
      description: Remove an IP address from the blocklist.
      operationId: unblockIP
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ip_address
              properties:
                ip_address:
                  type: string
                  format: ipv4
                  description: IP address to unblock
      responses:
        '200':
          description: IP unblocked successfully

  # ==================== Admin Settings ====================
  /admin/api/settings/storage:
    post:
      tags:
        - Admin
      summary: Update storage settings
      description: Modify storage-related configuration at runtime.
      operationId: updateStorageSettings
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StorageSettingsRequest'
      responses:
        '200':
          description: Settings updated successfully

  /admin/api/settings/security:
    post:
      tags:
        - Admin
      summary: Update security settings
      description: Modify security-related configuration at runtime.
      operationId: updateSecuritySettings
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecuritySettingsRequest'
      responses:
        '200':
          description: Settings updated successfully

  /admin/api/config-assistant/analyze:
    post:
      tags:
        - Admin
      summary: Configuration assistant
      description: Analyze deployment environment and get optimized configuration recommendations.
      operationId: analyzeConfig
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigAssistantRequest'
      responses:
        '200':
          description: Configuration recommendations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigAssistantResponse'

  # ==================== Admin User Management ====================
  /admin/api/users:
    get:
      tags:
        - Admin
      summary: List users
      description: Retrieve all users in the system.
      operationId: listUsers
      security:
        - adminAuth: []
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'

  /admin/api/users/create:
    post:
      tags:
        - Admin
      summary: Create user
      description: Create a new user account.
      operationId: createUser
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Username already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/users/{id}:
    put:
      tags:
        - Admin
      summary: Update user
      description: Update an existing user account.
      operationId: updateUser
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Admin
      summary: Delete user
      description: Delete a user account.
      operationId: deleteUser
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: User deleted successfully
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/users/{id}/enable:
    post:
      tags:
        - Admin
      summary: Enable user
      description: Enable a disabled user account.
      operationId: enableUser
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: User enabled successfully

  /admin/api/users/{id}/disable:
    post:
      tags:
        - Admin
      summary: Disable user
      description: Disable a user account.
      operationId: disableUser
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: User disabled successfully

  /admin/api/users/{id}/reset-password:
    post:
      tags:
        - Admin
      summary: Reset user password
      description: Reset a user's password to a new value.
      operationId: resetUserPassword
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - new_password
              properties:
                new_password:
                  type: string
                  format: password
                  description: New password
      responses:
        '200':
          description: Password reset successfully

  # ==================== Admin API Token Management ====================
  /admin/api/tokens:
    get:
      tags:
        - Admin
      summary: List all API tokens
      description: List all API tokens in the system (admin only).
      operationId: adminListTokens
      security:
        - adminAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Results per page
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
        - name: user_id
          in: query
          schema:
            type: integer
          description: Filter by user ID
      responses:
        '200':
          description: List of all tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminTokenListResponse'

  /admin/api/tokens/revoke:
    delete:
      tags:
        - Admin
      summary: Revoke any token
      description: Revoke any user's API token (admin only).
      operationId: adminRevokeToken
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: integer
          description: Token ID to revoke
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Token revoked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==================== Webhook Endpoints ====================
  /admin/api/webhooks:
    get:
      tags:
        - Webhooks
      summary: List webhook configurations
      description: Retrieve all configured webhooks.
      operationId: listWebhooks
      security:
        - adminAuth: []
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WebhookConfig'

    post:
      tags:
        - Webhooks
      summary: Create webhook configuration
      description: Create a new webhook endpoint.
      operationId: createWebhook
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookRequest'
      responses:
        '201':
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookConfig'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/webhooks/update:
    put:
      tags:
        - Webhooks
      summary: Update webhook configuration
      description: Update an existing webhook endpoint.
      operationId: updateWebhook
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: integer
          description: Webhook ID
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookRequest'
      responses:
        '200':
          description: Webhook updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookConfig'
        '404':
          description: Webhook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/webhooks/delete:
    delete:
      tags:
        - Webhooks
      summary: Delete webhook configuration
      description: Delete a webhook endpoint.
      operationId: deleteWebhook
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: integer
          description: Webhook ID
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Webhook deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '404':
          description: Webhook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/webhooks/test:
    post:
      tags:
        - Webhooks
      summary: Test webhook
      description: Send a test event to verify webhook configuration.
      operationId: testWebhook
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: integer
          description: Webhook ID
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookTestResponse'

  /admin/api/webhook-deliveries:
    get:
      tags:
        - Webhooks
      summary: List webhook deliveries
      description: Retrieve webhook delivery history with pagination.
      operationId: listWebhookDeliveries
      security:
        - adminAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 1000
          description: Results per page
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: List of deliveries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WebhookDelivery'

  /admin/api/webhook-deliveries/detail:
    get:
      tags:
        - Webhooks
      summary: Get webhook delivery details
      description: Retrieve details of a specific webhook delivery.
      operationId: getWebhookDelivery
      security:
        - adminAuth: []
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: integer
          description: Delivery ID
      responses:
        '200':
          description: Delivery details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookDelivery'
        '404':
          description: Delivery not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/webhook-deliveries/clear:
    post:
      tags:
        - Webhooks
      summary: Clear webhook deliveries
      description: Clear webhook delivery history.
      operationId: clearWebhookDeliveries
      security:
        - adminAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Deliveries cleared successfully

components:
  securitySchemes:
    sessionAuth:
      type: apiKey
      in: cookie
      name: user_session
      description: User session cookie obtained via /api/auth/login

    bearerAuth:
      type: http
      scheme: bearer
      description: |
        API token authentication. Token format: `safeshare_<64 hex chars>`
        
        Example: `Authorization: Bearer safeshare_a1b2c3d4...`

    adminAuth:
      type: apiKey
      in: cookie
      name: admin_session
      description: Admin session cookie obtained via /admin/api/login

  parameters:
    CSRFToken:
      name: X-CSRF-Token
      in: header
      required: true
      schema:
        type: string
      description: CSRF token from csrf_token cookie

  schemas:
    # ==================== Error Response ====================
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
      required:
        - error

    # ==================== Health Schemas ====================
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        uptime_seconds:
          type: integer
        total_files:
          type: integer
        storage_used_bytes:
          type: integer
          format: int64
        disk_total_bytes:
          type: integer
          format: int64
        disk_free_bytes:
          type: integer
          format: int64
        disk_available_bytes:
          type: integer
          format: int64
        disk_used_percent:
          type: number
        quota_limit_bytes:
          type: integer
          format: int64
        quota_used_percent:
          type: number
        database_metrics:
          $ref: '#/components/schemas/DatabaseMetrics'
        status_details:
          type: array
          items:
            type: string
          description: Present when status is degraded or unhealthy

    DatabaseMetrics:
      type: object
      properties:
        size_bytes:
          type: integer
          format: int64
        wal_size_bytes:
          type: integer
          format: int64
        page_count:
          type: integer
        page_size:
          type: integer
        index_count:
          type: integer

    LivenessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [alive]
        database_connected:
          type: boolean

    ReadinessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ready, not_ready]
        uptime_seconds:
          type: integer
        reason:
          type: string
          description: Present when not ready

    # ==================== Configuration Schemas ====================
    PublicConfig:
      type: object
      properties:
        version:
          type: string
          example: "2.8.4"
        max_file_size:
          type: integer
          format: int64
          description: Maximum file size in bytes
        default_expiration_hours:
          type: integer
        max_expiration_hours:
          type: integer
        chunked_upload_enabled:
          type: boolean
        chunked_upload_threshold:
          type: integer
          format: int64
        chunk_size:
          type: integer
          format: int64
        require_auth_for_upload:
          type: boolean

    # ==================== Authentication Schemas ====================
    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: user
        password:
          type: string
          format: password

    UserResponse:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [user, admin]
        require_password_change:
          type: boolean

    ChangePasswordRequest:
      type: object
      required:
        - current_password
        - new_password
        - confirm_password
      properties:
        current_password:
          type: string
          format: password
        new_password:
          type: string
          format: password
        confirm_password:
          type: string
          format: password

    # ==================== Upload Schemas ====================
    UploadResponse:
      type: object
      properties:
        claim_code:
          type: string
          description: Unique code to retrieve the file
          example: Xy9kLm8pQz4vDwE
        expires_at:
          type: string
          format: date-time
          nullable: true
        download_url:
          type: string
          format: uri
        max_downloads:
          type: integer
          nullable: true
        file_size:
          type: integer
          format: int64
        original_filename:
          type: string
        sha256_hash:
          type: string
          description: SHA-256 hash of the file

    ChunkedUploadInitRequest:
      type: object
      required:
        - filename
        - total_size
      properties:
        filename:
          type: string
          description: Original filename
        total_size:
          type: integer
          format: int64
          description: Total file size in bytes
        chunk_size:
          type: integer
          format: int64
          description: Chunk size (optional, uses server default)
        expires_in_hours:
          type: number
          description: Hours until expiration
        max_downloads:
          type: integer
          description: Maximum downloads
        password:
          type: string
          format: password
          description: Optional password protection

    ChunkedUploadInitResponse:
      type: object
      properties:
        upload_id:
          type: string
          format: uuid
        chunk_size:
          type: integer
          format: int64
        total_chunks:
          type: integer
        expires_at:
          type: string
          format: date-time
          description: Upload session expiration

    ChunkUploadResponse:
      type: object
      properties:
        upload_id:
          type: string
          format: uuid
        chunk_number:
          type: integer
        chunks_received:
          type: integer
        total_chunks:
          type: integer
        complete:
          type: boolean

    AsyncUploadResponse:
      type: object
      properties:
        upload_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [processing]
        message:
          type: string

    UploadStatusResponse:
      type: object
      properties:
        upload_id:
          type: string
          format: uuid
        filename:
          type: string
        status:
          type: string
          enum: [uploading, processing, completed, failed]
        chunks_received:
          type: integer
        total_chunks:
          type: integer
        missing_chunks:
          type: array
          items:
            type: integer
        complete:
          type: boolean
        claim_code:
          type: string
          description: Present when status is completed
        download_url:
          type: string
          description: Present when status is completed
        error_message:
          type: string
          description: Present when status is failed
        expires_at:
          type: string
          format: date-time

    # ==================== File Info Schemas ====================
    FileInfoResponse:
      type: object
      properties:
        claim_code:
          type: string
        original_filename:
          type: string
        file_size:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        download_count:
          type: integer
        max_downloads:
          type: integer
          nullable: true
        downloads_remaining:
          type: integer
          nullable: true
        password_protected:
          type: boolean
        sha256_hash:
          type: string

    # ==================== User Files Schemas ====================
    UserFilesResponse:
      type: object
      properties:
        files:
          type: array
          items:
            $ref: '#/components/schemas/UserFile'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    UserFile:
      type: object
      properties:
        id:
          type: integer
        claim_code:
          type: string
        original_filename:
          type: string
        file_size:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        download_count:
          type: integer
        completed_downloads:
          type: integer
        max_downloads:
          type: integer
          nullable: true
        password_protected:
          type: boolean
        sha256_hash:
          type: string

    # ==================== API Token Schemas ====================
    CreateTokenRequest:
      type: object
      required:
        - name
        - scopes
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Human-readable token name
          example: My Backup Script
        scopes:
          type: array
          items:
            type: string
            enum: [upload, download, manage, admin]
          minItems: 1
          description: Permission scopes
        expires_in_days:
          type: integer
          minimum: 1
          maximum: 365
          nullable: true
          description: Days until expiration (null for no expiration)

    TokenCreatedResponse:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        token:
          type: string
          description: |
            Full token value. Only shown once at creation.
            Format: safeshare_<64 hex chars>
          example: safeshare_a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd
        scopes:
          type: array
          items:
            type: string
        expires_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    TokenListResponse:
      type: object
      properties:
        tokens:
          type: array
          items:
            $ref: '#/components/schemas/TokenInfo'

    TokenInfo:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        token_prefix:
          type: string
          description: Masked token for identification
          example: safeshare_a1b***bcd
        scopes:
          type: array
          items:
            type: string
        last_used_at:
          type: string
          format: date-time
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    AdminTokenListResponse:
      type: object
      properties:
        tokens:
          type: array
          items:
            $ref: '#/components/schemas/AdminTokenInfo'
        total:
          type: integer

    AdminTokenInfo:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        username:
          type: string
        name:
          type: string
        token_prefix:
          type: string
        scopes:
          type: array
          items:
            type: string
        last_used_at:
          type: string
          format: date-time
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    # ==================== Admin Schemas ====================
    DashboardResponse:
      type: object
      properties:
        stats:
          $ref: '#/components/schemas/DashboardStats'
        files:
          type: array
          items:
            $ref: '#/components/schemas/AdminFile'
        blocked_ips:
          type: array
          items:
            $ref: '#/components/schemas/BlockedIP'
        total_files:
          type: integer

    DashboardStats:
      type: object
      properties:
        total_files:
          type: integer
        storage_used_bytes:
          type: integer
          format: int64
        quota_used_percent:
          type: number
        blocked_ips_count:
          type: integer
        partial_upload_size_bytes:
          type: integer
          format: int64
        total_users:
          type: integer

    AdminFile:
      type: object
      properties:
        id:
          type: integer
        claim_code:
          type: string
        original_filename:
          type: string
        file_size:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        download_count:
          type: integer
        max_downloads:
          type: integer
          nullable: true
        uploader_ip:
          type: string
        user_id:
          type: integer
          nullable: true
        username:
          type: string
          nullable: true

    BlockedIP:
      type: object
      properties:
        ip_address:
          type: string
        reason:
          type: string
        blocked_at:
          type: string
          format: date-time

    AdminConfigResponse:
      type: object
      properties:
        chunk_size:
          type: integer
          format: int64
        chunked_upload_threshold:
          type: integer
          format: int64
        encryption_enabled:
          type: boolean
        max_file_size:
          type: integer
          format: int64
        read_timeout:
          type: integer
        write_timeout:
          type: integer

    StorageSettingsRequest:
      type: object
      properties:
        quota_gb:
          type: integer
          description: Storage quota in GB
        max_file_size_bytes:
          type: integer
          format: int64
        default_expiration_hours:
          type: integer
        max_expiration_hours:
          type: integer

    SecuritySettingsRequest:
      type: object
      properties:
        rate_limit_upload:
          type: integer
        rate_limit_download:
          type: integer
        blocked_extensions:
          type: array
          items:
            type: string
          example: [".exe", ".bat", ".cmd"]

    ConfigAssistantRequest:
      type: object
      properties:
        storage_type:
          type: string
          enum: [local, network, cloud]
        network_speed_mbps:
          type: integer
        cdn_used:
          type: boolean
        cdn_timeout_seconds:
          type: integer
        average_file_size_mb:
          type: integer
        concurrent_users:
          type: integer
        network_latency_ms:
          type: integer

    ConfigAssistantResponse:
      type: object
      properties:
        recommendations:
          type: object
          additionalProperties: true
        current_settings:
          type: object
          additionalProperties: true
        immediate_settings:
          type: object
          additionalProperties: true
        restart_required_settings:
          type: object
          additionalProperties: true
        reasoning:
          type: array
          items:
            type: string

    # ==================== User Management Schemas ====================
    UserListResponse:
      type: object
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/AdminUserInfo'

    AdminUserInfo:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [user, admin]
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        last_login_at:
          type: string
          format: date-time
          nullable: true

    CreateUserRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
        password:
          type: string
          format: password
          minLength: 8
        email:
          type: string
          format: email
        role:
          type: string
          enum: [user, admin]
          default: user

    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        role:
          type: string
          enum: [user, admin]

    # ==================== Webhook Schemas ====================
    WebhookConfig:
      type: object
      properties:
        id:
          type: integer
        url:
          type: string
          format: uri
        secret:
          type: string
          description: Masked in list responses
        service_token:
          type: string
          description: Masked in list responses
        enabled:
          type: boolean
        events:
          type: array
          items:
            type: string
            enum: [file.uploaded, file.downloaded, file.deleted, file.expired]
        format:
          type: string
          enum: [safeshare, gotify, ntfy, discord]
        max_retries:
          type: integer
        timeout_seconds:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateWebhookRequest:
      type: object
      required:
        - url
        - secret
        - enabled
        - events
      properties:
        url:
          type: string
          format: uri
          description: Webhook endpoint URL (HTTP/HTTPS only)
        secret:
          type: string
          description: Secret key for HMAC signature verification
        service_token:
          type: string
          description: Authentication token for Gotify/ntfy services
        enabled:
          type: boolean
        events:
          type: array
          items:
            type: string
            enum: [file.uploaded, file.downloaded, file.deleted, file.expired]
          minItems: 1
        format:
          type: string
          enum: [safeshare, gotify, ntfy, discord]
          default: safeshare
        max_retries:
          type: integer
          default: 5
        timeout_seconds:
          type: integer
          default: 30

    WebhookTestResponse:
      type: object
      properties:
        success:
          type: boolean
        response_code:
          type: integer
        response_body:
          type: string
        error:
          type: string
          description: Present on failure

    WebhookDelivery:
      type: object
      properties:
        id:
          type: integer
        webhook_config_id:
          type: integer
        event_type:
          type: string
        payload:
          type: string
          description: JSON payload
        attempt_count:
          type: integer
        status:
          type: string
          enum: [pending, success, failed, retrying]
        response_code:
          type: integer
          nullable: true
        response_body:
          type: string
          nullable: true
        error_message:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        next_retry_at:
          type: string
          format: date-time
          nullable: true
